use std

const main = {
	/* Raw ASCII */
	std.assert(std.strcellwidth("foobar") == 6, "wrong width of \"foobar\"")
	std.assert(std.strcellwidth("") == 0, "wrong width of \"\"")

	/* Control characters */
	var ab = [ (0x63 : byte), (0x00 : byte), (0x64 : byte) ][:]
	std.assert(std.strcellwidth(ab) == 2, "wrong width of \"a^@b\"")

	/* Accents and combining marks */
	std.assert(std.strcellwidth("Î‘Ï…Ï„ÏŒ") == 4, "wrong width of \"Î‘Ï…Ï„ÏŒ")
	std.assert(std.strcellwidth("Å—Å¡È›Å«Å¾Ã¤Ã±") == 7, "wrong width of \"Å—Å¡È›Å«Å¾Ã¤Ã±")
	std.assert(std.strcellwidth("cÍ¯Í‘ÌˆÌ„Ì¿ÍŠÍ£Í„ÍÌ¡Ì¸Ì¶Ì¡Ì—Ì£Í•ÌªÍ–hÍ„ÍƒÍªÍ«Ì‹ÌµÍ˜Ì¸Ì›Í¡Ì¥ÍšÌ­Ì£ÍˆÍ–Ì¼ÍˆÍ“Í“Ì«ÍaÍ†Í‚Ì¿Í¬Ì‚Í‹Í’ÌˆÌ¢Ì©Ì±Ì Í…Ì˜Í…Ì¹Ì¤Ì¯ÍšÌ¦Ì°Ì¼Ì¯Ì²ÌoÍ¦Ì‰Ì†Ì…ÌƒÌÍ¤Ì†Í‘Í£ÌšÌ½ÌÌ·Ì·Ì¶Ì¥Í–Ì¼Ì®Ì³Ì—ÍšsÌ“ÌÌÌ„ÍÍ¡Í¡ÍÍÌ–ÌÌŸÌ±") == 5, "wrong width of \"cÍ¯Í‘ÌˆÌ„Ì¿ÍŠÍ£Í„ÍÌ¡Ì¸Ì¶Ì¡Ì—Ì£Í•ÌªÍ–hÍ„ÍƒÍªÍ«Ì‹ÌµÍ˜Ì¸Ì›Í¡Ì¥ÍšÌ­Ì£ÍˆÍ–Ì¼ÍˆÍ“Í“Ì«ÍaÍ†Í‚Ì¿Í¬Ì‚Í‹Í’ÌˆÌ¢Ì©Ì±Ì Í…Ì˜Í…Ì¹Ì¤Ì¯ÍšÌ¦Ì°Ì¼Ì¯Ì²ÌoÍ¦Ì‰Ì†Ì…ÌƒÌÍ¤Ì†Í‘Í£ÌšÌ½ÌÌ·Ì·Ì¶Ì¥Í–Ì¼Ì®Ì³Ì—ÍšsÌ“ÌÌÌ„ÍÍ¡Í¡ÍÍÌ–ÌÌŸÌ±\"")
	std.assert(std.strcellwidth("qÌ†") == 1, "wrong width of \"qÌ†\"")
	std.assert(std.strcellwidth(" Í âƒ” âƒ«") == 3, "wrong width of \" Í âƒ” âƒ«\"")
	std.assert(std.strcellwidth("fÍâƒ”âƒ«") == 1, "wrong width of \"fÍâƒ”âƒ«\"")

	/* Non-Latin scripts */
	std.assert(std.strcellwidth("ÎŸá½Ï‡á½¶ Ï„Î±á½Ï„á½° Ï€Î±Ïá½·ÏƒÏ„Î±Ï„Î±á½·") == 21, \
		"wrong width of Greek")
	std.assert(std.strcellwidth("Ğ¯ Ñ‡ĞµĞ»Ğ¾Ğ²ĞµĞº Ğ±Ğ¾Ğ»ÑŒĞ½Ğ¾Ğ¹...") == 20, \
		"wrong width of Cyrillic")
	std.assert(std.strcellwidth("éŠ€æ²³ã®æ­´å²ãŒã¾ãŸ1ãƒšãƒ¼ã‚¸") == 23, \
		"wrong width of CJK")
	std.assert(std.strcellwidth("áš»á›– áš³áš¹áš«áš¦ áš¦áš«á› áš»á›– á›’áš¢á›á›–") == 19, \
		"wrong width of runes")
	std.assert(std.strcellwidth("ğ’€¸ ğ’Œ‹ğ’…— ğ’†· ğ’‚…ğ’Œ’ ğ’œ ğ’€­ğ’‰Œğ’„¿ ğ’ˆ— ğ’ğ’‰Œ ğ’‹¬") == 22, \
		"wrong width of Cuneiform")

	/* graphemestep() */
	var s = "Ì€aå²c\tĞ¯xÌ€Ì€Ì€Ì€Ì€\nzÌ‰"
	var sub, rest

	(sub, rest) = std.graphemestep(s)
	std.assert(std.eq(sub, "Ì€"), "didn't get U+0300 as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, "a"), "didn't get \"a\" as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, "å²"), "didn't get \"å²\" as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, "c"), "didn't get \"c\" as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, "\t"), "didn't get \"\\t\" as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, "Ğ¯"), "didn't get \"Ğ¯\" as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, "xÌ€Ì€Ì€Ì€Ì€"), "didn't get \"xÌ€Ì€Ì€Ì€Ì€\" as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, "\n"), "didn't get \"\\n\" as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, "zÌ‰"), "didn't get \"zÌ‰\" as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(sub.len == 0, "didn't get \"\" as last grapheme")


	/* with excessive combiners */
	s = "\tcÍ¯Í‘ÌˆÌ„Ì¿ÍŠÍ£Í„ÍÌ¡Ì¸Ì¶Ì¡Ì—Ì£Í•ÌªÍ–hÍ„ÍƒÍªÍ«Ì‹ÌµÍ˜Ì¸Ì›Í¡Ì¥ÍšÌ­Ì£ÍˆÍ–Ì¼ÍˆÍ“Í“Ì«ÍaÍ†Í‚Ì¿Í¬Ì‚Í‹Í’ÌˆÌ¢Ì©Ì±Ì Í…Ì˜Í…Ì¹Ì¤Ì¯ÍšÌ¦Ì°Ì¼Ì¯Ì²ÌoÍ¦Ì‰Ì†Ì…ÌƒÌÍ¤Ì†Í‘Í£ÌšÌ½ÌÌ·Ì·Ì¶Ì¥Í–Ì¼Ì®Ì³Ì—ÍšsÌ“ÌÌÌ„ÍÍ¡Í¡ÍÍÌ–ÌÌŸÌ±"

	(sub, rest) = std.graphemestep(s)
	std.assert(std.eq(sub, "\t"), "didn't get \"\\t\" as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, "cÍ¯Í‘ÌˆÌ„Ì¿ÍŠÍ£Í„ÍÌ¡Ì¸Ì¶Ì¡Ì—Ì£Í•ÌªÍ–"), "didn't get \"cÍ¯Í‘ÌˆÌ„Ì¿ÍŠÍ£Í„ÍÌ¡Ì¸Ì¶Ì¡Ì—Ì£Í•ÌªÍ–\" as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, "hÍ„ÍƒÍªÍ«Ì‹ÌµÍ˜Ì¸Ì›Í¡Ì¥ÍšÌ­Ì£ÍˆÍ–Ì¼ÍˆÍ“Í“Ì«Í"), "didn't get \"hÍ„ÍƒÍªÍ«Ì‹ÌµÍ˜Ì¸Ì›Í¡Ì¥ÍšÌ­Ì£ÍˆÍ–Ì¼ÍˆÍ“Í“Ì«Í\" as next grapheme, it was {}", rest)

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, "aÍ†Í‚Ì¿Í¬Ì‚Í‹Í’ÌˆÌ¢Ì©Ì±Ì Í…Ì˜Í…Ì¹Ì¤Ì¯ÍšÌ¦Ì°Ì¼Ì¯Ì²Ì"), "didn't get \"aÍ†Í‚Ì¿Í¬Ì‚Í‹Í’ÌˆÌ¢Ì©Ì±Ì Í…Ì˜Í…Ì¹Ì¤Ì¯ÍšÌ¦Ì°Ì¼Ì¯Ì²Ì\" as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, "oÍ¦Ì‰Ì†Ì…ÌƒÌÍ¤Ì†Í‘Í£ÌšÌ½ÌÌ·Ì·Ì¶Ì¥Í–Ì¼Ì®Ì³Ì—Íš"), "didn't get \"oÍ¦Ì‰Ì†Ì…ÌƒÌÍ¤Ì†Í‘Í£ÌšÌ½ÌÌ·Ì·Ì¶Ì¥Í–Ì¼Ì®Ì³Ì—Íš\" as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, "sÌ“ÌÌÌ„ÍÍ¡Í¡ÍÍÌ–ÌÌŸÌ±"), "didn't get \"sÌ“ÌÌÌ„ÍÍ¡Í¡ÍÍÌ–ÌÌŸÌ±\" as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(sub.len == 0, "didn't get \"\" as last grapheme")

	/* now with invalid UTF-8 */
	s = [ ('A' : byte), ('b' : byte), (0xFE : byte),
	      (0xFF : byte), (0x92 : byte), ('c' : byte) ][:]

	(sub, rest) = std.graphemestep(s)
	std.assert(std.eq(sub, "A"), "didn't get \"A\" as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, "b"), "didn't get \"b\" as next grapheme")


	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, [ (0xFE : byte) ][:]), "didn't get 0xEE, len={} as next grapheme", sub.len)

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, [ (0xFF : byte) ][:]), "didn't get 0xEA as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, [ (0x92 : byte) ][:]), "didn't get 0xEF as next grapheme")

	(sub, rest) = std.graphemestep(rest)
	std.assert(std.eq(sub, "c"), "didn't get \"c\" as next grapheme")
}
